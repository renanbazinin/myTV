<!DOCTYPE html>
<html>
<head>
  <style>
    .channel-button {
      width: 200px;
      height: 200px;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      margin: 10px;
      border: none;
      cursor: pointer;
    }

    .channel-button-support {
      width: 200px;
      height: 50px;
      margin: 10px;
      border: none;
      cursor: pointer;
    }

    .video-element {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="channelPicker"></div>
  <div id="videoContainer"></div>

  <script>
    function createButton(name, logo, url, groupTitle) {
      const button = document.createElement('button');
      button.textContent = name;
      button.style.backgroundImage = `url(${logo})`;
      button.className = 'channel-button';

      button.addEventListener('click', () => {
        playStream(url);
      });

      return button;
    }

    async function playStream(url) {
      const videoElement = document.createElement('video');
      videoElement.className = 'video-element';
      videoElement.controls = true;
      videoElement.autoplay = true;

      const canPlayHls = videoElement.canPlayType('application/vnd.apple.mpegurl');
      const canPlayMp4 = videoElement.canPlayType('video/mp4');

      if (canPlayHls !== '') {
        const response = await fetch(url);
        const m3u8Content = await response.text();
        const parser = new DOMParser();
        const m3u8DOM = parser.parseFromString(m3u8Content, 'application/xml');
        const playlist = m3u8DOM.querySelector('playlist');
        const hlsUrl = new URL(url);
        const basePath = hlsUrl.origin + hlsUrl.pathname.substring(0, hlsUrl.pathname.lastIndexOf('/') + 1);

        const hlsVideoSource = playlist.querySelector('media:first-of-type').getAttribute('url');
        const hlsSource = document.createElement('source');
        hlsSource.src = basePath + hlsVideoSource;
        hlsSource.type = 'application/x-mpegURL';

        videoElement.appendChild(hlsSource);
      } else if (canPlayMp4 !== '') {
        const mp4Source = document.createElement('source');
        mp4Source.src = url;
        mp4Source.type = 'video/mp4';

        videoElement.appendChild(mp4Source);
      } else {
        console.error('Video format is not supported');
        return;
      }

      document.getElementById('channelPicker').style.display = 'none';
      document.getElementById('videoContainer').innerHTML = '';
      document.getElementById('videoContainer').appendChild(videoElement);
    }

    function start() {
      fetch('https://raw.githubusercontent.com/renanbazinin/myTV/main/movies.m3u')
        .then(response => response.text())
        .then(data => {
          const channelPicker = document.getElementById('channelPicker');
          channelPicker.innerHTML = '';

          const supportButton = document.createElement('a');
          supportButton.id = 'supportButton';
          supportButton.href = 'https://www.buymeacoffee.com/renanbazinin';
          supportButton.target = '_blank';
          const supportButtonInner = document.createElement('button');
          supportButtonInner.className = 'channel-button-support';
          supportButtonInner.textContent = 'Support Me';
          supportButton.appendChild(supportButtonInner);
          document.body.appendChild(supportButton);

          const lines = data.split(/\r?\n/);
          const channels = [];
          let currentChannel = {};

          lines.forEach(line => {
            if (line.startsWith('#EXTINF:-1')) {
              if (currentChannel.name && currentChannel.logo && currentChannel.url) {
                channels.push(currentChannel);
                currentChannel = {};
              }
              const nameMatch = line.match(/tvg-id="([^"]+)"/);
              const logoMatch = line.match(/tvg-logo="([^"]+)"/);
              const groupTitleMatch = line.match(/group-title="([^"]+)"/);
              if (nameMatch && logoMatch) {
                currentChannel.name = nameMatch[1];
                currentChannel.logo = logoMatch[1];
                currentChannel.groupTitle = groupTitleMatch[1];
              }
            } else if (line.trim() !== '' && !line.startsWith('#')) {
              currentChannel.url = line;
            }
          });

          channels.forEach(channel => {
            const button = createButton(channel.name, channel.logo, channel.url, channel.groupTitle);
            channelPicker.appendChild(button);
          });
        });
    }

    // Call the start function to begin the process
    start();
  </script>
</body>
</html>
